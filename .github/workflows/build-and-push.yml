name: Build and Push Docker Image

on:
  # æ¯æ—¥ UTC æ—¶é—´ 2:00 (åŒ—äº¬æ—¶é—´ 10:00) è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 2 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # ä»£ç æŽ¨é€æ—¶ä¹Ÿè§¦å‘
  push:
    branches:
      - main

env:
  # åªä½¿ç”¨ GitHub Container Registry (å…è´¹)
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/nanobot

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.sync.outputs.updated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/HKUDS/nanobot.git || true
          git fetch upstream

      - name: Sync with upstream
        id: sync
        run: |
          # èŽ·å–å½“å‰ commit
          BEFORE=$(git rev-parse HEAD)
          
          # åˆå¹¶ä¸Šæ¸¸æ›´æ–°
          git merge upstream/main --no-edit --allow-unrelated-histories || true
          
          # èŽ·å–åˆå¹¶åŽ commit
          AFTER=$(git rev-parse HEAD)
          
          if [ "$BEFORE" != "$AFTER" ]; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "::notice::Upstream changes detected, will rebuild"
          else
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "::notice::No upstream changes"
          fi

      - name: Push changes
        if: steps.sync.outputs.updated == 'true'
        run: git push origin main

  build-and-push:
    runs-on: ubuntu-latest
    needs: sync-upstream
    # æ€»æ˜¯æž„å»ºï¼ˆé¦–æ¬¡è¿è¡Œæˆ–æœ‰æ›´æ–°æ—¶ï¼‰
    if: always()
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version info
        id: version
        run: |
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.date }}
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.date }}-${{ steps.version.outputs.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create release notes
        run: |
          echo "## ðŸˆ nanobot Docker Image Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.version.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Images Published (GitHub Container Registry)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.IMAGE_NAME }}:${{ steps.version.outputs.date }}\`" >> $GITHUB_STEP_SUMMARY
